<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thiếu Nhi Thánh Thể Quiz</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header class="header">
    <button class="logo-btn">
      <img src="assets/logo.png" alt="Logo" class="logo">
    </button>
    <div class="text-center">
      <h1>Bài Đánh Giá</h1>
      <p>Giáo Xứ Chánh Toà Mỹ Tho - Xứ Đoàn Các Thánh Tử Đạo Việt Nam</p>
    </div>
    <div style="width: 120px;"></div>
  </header>
  <main class="main-content">
    <section id="browserWarning" class="hidden">
      <p class="error-message">Vui lòng mở link tại Google Chrome, Safari hoặc Firefox để thực hiện bài kiểm tra.</p>
    </section>
    <section id="quizSection" class="hidden">
      <div class="mb-4">
        <p class="timer" id="timer">Thời gian còn lại: 90:00</p>
        <p>Họ và tên: <input type="text" id="studentName" required></p>
      </div>
      <div id="quizContainer"></div>
      <button id="submitBtn">Nộp bài</button>
      <div id="resultContainer" class="hidden">
        <h2 class="section-title">Kết quả</h2>
        <p id="mcqScore"></p>
        <p id="submissionInfo"></p>
        <p id="violationMarks"></p>
        <h3 class="font-bold mt-4">Câu trả lời tự luận:</h3>
        <div id="openEndedAnswers"></div>
      </div>
      <form id="emailForm" action="https://formsubmit.co/notification2411.huynhdutruong@gmail.com" method="POST" class="hidden">
        <input type="hidden" name="StudentName" id="formStudentName">
        <input type="hidden" name="MCQScore" id="formMCQScore">
        <input type="hidden" name="SubmissionInfo" id="formSubmissionInfo">
        <input type="hidden" name="ViolationMarks" id="formViolationMarks">
        <input type="hidden" name="Answers" id="formAnswers">
        <input type="hidden" name="_subject" value="Thiếu Nhi Thánh Thể Quiz Submission">
        <input type="hidden" name="_captcha" value="false">
      </form>
    </section>
  </main>

  <script>
    let questions = [];
    let timerInterval;
    let timeLeft = 90 * 60; // 90 minutes in seconds
    let tabSwitchMarks = 0;
    let copyPasteMarks = 0;
    const maxMarks = 3;

    // Browser detection
    const userAgent = navigator.userAgent;
    const allowedBrowsers = ['Chrome', 'Safari', 'Firefox'];
    const isAllowedBrowser = allowedBrowsers.some(browser => userAgent.includes(browser));
    if (!isAllowedBrowser) {
      document.getElementById('browserWarning').classList.remove('hidden');
    } else {
      document.getElementById('quizSection').classList.remove('hidden');
      initializeApp();
    }

    function initializeApp() {
      // Load JSON data
      fetch('data/txmhoreb.json')
        .then(response => response.json())
        .then(data => {
          questions = data;
          initializeQuiz();
        })
        .catch(error => console.error('Error loading JSON:', error));

      // Tab switch detection
      document.addEventListener('visibilitychange', handleTabSwitch);

      // Copy/paste detection
      document.addEventListener('copy', handleCopyPaste);
      document.addEventListener('paste', handleCopyPaste);
      document.addEventListener('contextmenu', e => e.preventDefault()); // Disable right-click
    }

    function handleTabSwitch() {
      if (document.hidden && timeLeft > 0) {
        tabSwitchMarks++;
        showNotification('Cảnh báo: Không được chuyển tab! Bài của bạn đã bị đánh dấu.');
        checkMarksAndSubmit();
      }
    }

    function handleCopyPaste(e) {
      e.preventDefault();
      if (timeLeft > 0) {
        copyPasteMarks++;
        showNotification('Cảnh báo: Không được sao chép hoặc dán! Bài của bạn đã bị đánh dấu.');
        checkMarksAndSubmit();
      }
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification error';
      notification.textContent = message;
      document.body.appendChild(notification);
      notification.style.display = 'block';
      setTimeout(() => notification.remove(), 3000);
    }

    function checkMarksAndSubmit() {
      const totalMarks = tabSwitchMarks + copyPasteMarks;
      if (totalMarks >= maxMarks) {
        submitQuiz(true);
      }
    }

    function initializeQuiz() {
      // Separate open-ended and multiple-choice questions
      const openEnded = questions.filter(q => q.type === 'open-ended');
      const multipleChoice = questions.filter(q => q.type === 'multiple-choice');

      // Randomly select 10 open-ended and 40 multiple-choice questions
      const selectedOpenEnded = shuffleArray(openEnded).slice(0, 10);
      const selectedMultipleChoice = shuffleArray(multipleChoice).slice(0, 40);
      const selectedQuestions = [...selectedOpenEnded, ...selectedMultipleChoice];

      // Shuffle all selected questions
      const shuffledQuestions = shuffleArray(selectedQuestions);

      // Render questions
      const quizContainer = document.getElementById('quizContainer');
      shuffledQuestions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'question-container';
        div.innerHTML = `
          <p>Câu ${index + 1}: ${q.question}</p>
          ${q.type === 'open-ended' ? `
            <textarea name="answer-${q.id}" rows="4"></textarea>
          ` : `
            <label class="radio-label"><input type="radio" name="answer-${q.id}" value="1"> ${q.option1}</label>
            <label class="radio-label"><input type="radio" name="answer-${q.id}" value="2"> ${q.option2}</label>
            <label class="radio-label"><input type="radio" name="answer-${q.id}" value="3"> ${q.option3}</label>
            <label class="radio-label"><input type="radio" name="answer-${q.id}" value="4"> ${q.option4}</label>
          `}
        `;
        quizContainer.appendChild(div);
      });

      // Start timer
      startTimer();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = `Thời gian còn lại: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitQuiz(false);
        }
      }, 1000);
    }

    function submitQuiz(isViolation = false) {
      clearInterval(timerInterval);
      const studentName = document.getElementById('studentName').value;
      if (!studentName.trim()) {
        showNotification('Vui lòng nhập họ và tên!');
        return;
      }

      let mcqCorrect = 0;
      const openEndedAnswers = [];
      const allAnswers = [];

      questions.forEach(q => {
        if (q.type === 'multiple-choice') {
          const selected = document.querySelector(`input[name="answer-${q.id}"]:checked`);
          if (selected && selected.value === q.correct_answer) {
            mcqCorrect++;
          }
          allAnswers.push({
            id: q.id,
            question: q.question,
            type: q.type,
            answer: selected ? q[`option${selected.value}`] : 'Không chọn',
            correct: q[`option${q.correct_answer}`]
          });
        } else {
          const answer = document.querySelector(`textarea[name="answer-${q.id}"]`)?.value || '';
          if (answer.trim()) {
            openEndedAnswers.push({ id: q.id, question: q.question, answer });
          }
          allAnswers.push({
            id: q.id,
            question: q.question,
            type: q.type,
            answer: answer || 'Không trả lời'
          });
        }
      });

      // Get submission details
      const submissionTime = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
      const deviceName = navigator.platform || 'Unknown Device';
      let browserName = 'Unknown';
      if (userAgent.includes('Chrome')) browserName = 'Google Chrome';
      else if (userAgent.includes('Safari')) browserName = 'Safari';
      else if (userAgent.includes('Firefox')) browserName = 'Firefox';

      const submissionInfo = `Máy dùng: ${deviceName}, Thời gian nộp: ${submissionTime}, Trình duyệt: ${browserName}`;
      const violationMarks = `Bài bị đánh dấu: ${tabSwitchMarks} lần chuyển tab, ${copyPasteMarks} lần sao chép/dán`;

      // Display results
      document.getElementById('resultContainer').classList.remove('hidden');
      document.getElementById('mcqScore').textContent = `[Trắc nghiệm: ${mcqCorrect} câu đúng]`;
      document.getElementById('submissionInfo').textContent = submissionInfo;
      document.getElementById('violationMarks').textContent = violationMarks;
      const openEndedDiv = document.getElementById('openEndedAnswers');
      openEndedAnswers.forEach(a => {
        const p = document.createElement('p');
        p.innerHTML = `<strong>Câu ${a.id}:</strong> ${a.question}<br>Trả lời: ${a.answer}`;
        openEndedDiv.appendChild(p);
      });

      // Prepare email data
      document.getElementById('formStudentName').value = studentName;
      document.getElementById('formMCQScore').value = `${mcqCorrect}/40`;
      document.getElementById('formSubmissionInfo').value = submissionInfo;
      document.getElementById('formViolationMarks').value = violationMarks;
      document.getElementById('formAnswers').value = JSON.stringify(allAnswers);
      document.getElementById('emailForm').submit();

      // Disable submit button and remove event listeners
      document.getElementById('submitBtn').disabled = true;
      document.removeEventListener('visibilitychange', handleTabSwitch);
      document.removeEventListener('copy', handleCopyPaste);
      document.removeEventListener('paste', handleCopyPaste);
      document.removeEventListener('contextmenu', e => e.preventDefault());
    }

    document.getElementById('submitBtn').addEventListener('click', () => submitQuiz(false));
  </script>
</body>
</html>