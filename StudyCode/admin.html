<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="Admin Dashboard - Xứ Đoàn Các Thánh Tử Đạo Việt Nam - Giáo Xứ Chánh Tòa Mỹ Tho">
    <meta name="keywords" content="Admin Dashboard, Ban Truyền Thông, Xứ Đoàn, Giáo Xứ Chánh Tòa Mỹ Tho, Quản lý thành viên, Ghi chú">
    <meta name="theme-color" content="#cc3048">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:title" content="Admin Dashboard - Ban Truyền Thông">
    <meta property="og:description" content="Quản lý thành viên và ghi chú cho Xứ Đoàn Các Thánh Tử Đạo Việt Nam - Giáo Xứ Chánh Tòa Mỹ Tho">
    <meta property="og:image" content="icon/icon-192x192.png">
    <meta property="og:url" content="https://your-site-url.com">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon/icon-192x192.png">
    <title>Admin Dashboard - Ban Truyền Thông</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #cc3048;
            --primary-dark: #b7142a;
            --accent: #FFD700;
            --dark-bg: #1A1A1A;
            --text: #E0E0E0;
            --error: #EF4444;
            --card-bg: #252526;
            --border-color: #3C3C3C;
            --success-color: #10B981;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.15s ease-in-out;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
            color: var(--text);
            line-height: 1.5;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85rem; /* Giảm font size mặc định */
        }

        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text);
            padding: 1rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .header h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem; /* Giảm từ 2rem */
            font-weight: 700;
            margin: 0;
        }

        .navbar {
            background: var(--dark-bg);
            padding: 0.5rem;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: var(--shadow-md);
            z-index: 1000;
            height: 50px; /* Giảm chiều cao navbar */
        }

        .navbar a {
            color: var(--text);
            padding: 0.4rem;
            font-size: 0.8rem; /* Giảm từ 0.875rem */
            text-align: center;
            border-radius: 0.4rem;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .navbar a i {
            font-size: 1rem; /* Giảm từ 1.25rem */
            margin-bottom: 0.2rem;
        }

        .navbar a:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -25px;
            background: var(--primary-dark);
            color: var(--text);
            padding: 0.2rem 0.4rem;
            border-radius: 0.2rem;
            font-size: 0.65rem; /* Giảm từ 0.75rem */
            white-space: nowrap;
            z-index: 1001;
        }

        .navbar a.active {
            background: var(--primary);
            color: var(--accent);
        }

        .container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            overflow-y: auto;
            min-height: calc(100dvh - 100px);
            padding-bottom: 50px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.8rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin: 1rem 0;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .card.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem; /* Giảm từ 1.75rem */
            color: var(--accent);
            margin-bottom: 1rem;
            text-align: center;
        }

        .input, select.input {
            background: #1E1E1E;
            border: 1px solid var(--border-color);
            border-radius: 0.4rem;
            padding: 0.5rem;
            color: var(--text);
            width: 100%;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem; /* Giảm từ 0.875rem */
        }

        .input:focus, select.input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
        }

        .btn {
            background: var(--primary);
            color: var(--text);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.4rem;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            transition: var(--transition);
            margin-right: 0.4rem;
            font-size: 0.8rem; /* Giảm kích thước chữ */
        }

        .btn:disabled {
            background: #3C3C3C;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .rank-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .rank-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            font-size: 0.75rem; /* Giảm từ 0.875rem */
            border-bottom: 1px solid var(--border-color);
        }

        .rank-list li:last-child {
            border-bottom: none;
        }

        .member-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.8rem;
        }

        .member-table th, .member-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem; /* Giảm từ 0.875rem */
        }

        .member-table th {
            background: #1E1E1E;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .member-table tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .member-card {
            background: #1E1E1E;
            border: 1px solid var(--border-color);
            border-radius: 0.4rem;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .member-card p {
            margin: 0.3rem 0;
            font-size: 0.75rem; /* Giảm từ 0.875rem */
        }

        .notes-form textarea, .doc-content textarea {
            background: #1E1E1E;
            border: 1px solid var(--border-color);
            border-radius: 0.4rem;
            padding: 0.5rem;
            color: var(--text);
            width: 100%;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem; /* Giảm từ 0.875rem */
            resize: vertical;
            height: 120px; /* Giảm từ 150px */
        }

        .notes-form textarea:focus, .doc-content textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3);
        }

        .notes-form .input-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .notes-form .input-group i {
            cursor: pointer;
            color: var(--primary);
            font-size: 1rem; /* Giảm từ 1.25rem */
        }

        .notes-form .input-group i:hover {
            color: var(--accent);
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            padding: 1rem;
            border-radius: 0.4rem;
            box-shadow: var(--shadow-md);
            max-width: 90%;
            width: 280px;
            font-size: 0.75rem; /* Giảm từ 0.875rem */
            z-index: 1001;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
        }

        .doc-content {
            background: #1E1E1E;
            border: 1px solid var(--border-color);
            border-radius: 0.4rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .button-group {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
        }

        .back-to-top {
            position: fixed;
            bottom: 70px;
            right: 15px;
            background: var(--primary);
            color: var(--text);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            z-index: 1000;
            transition: var(--transition);
        }

        .back-to-top:hover {
            background: var(--primary-dark);
            color: var(--accent);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: #1E1E1E;
            border: 1px solid var(--border-color);
            border-radius: 0.4rem;
            padding: 0.8rem;
            text-align: center;
        }

        .stat-card h4 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            margin-bottom: 0.4rem;
            font-size: 0.9rem; /* Giảm từ 1rem */
        }

        .stat-card p {
            font-size: 1.2rem; /* Giảm từ 1.5rem */
            font-weight: 500;
        }

        .chart-container {
            max-width: 500px; /* Giảm từ 600px */
            margin: 1.5rem auto;
        }

        .error-message {
            color: var(--error);
            text-align: center;
            padding: 0.8rem;
            border: 1px solid var(--error);
            border-radius: 0.4rem;
            margin-bottom: 0.8rem;
            font-size: 0.75rem; /* Giảm từ 0.875rem */
        }

        @media (max-width: 1024px) {
            body {
                font-size: 0.7rem; /* Giảm font size trên di động */
            }
            .header h2 {
                font-size: 1.25rem; /* Giảm từ 1.5rem */
            }
            .navbar {
                height: 40px; /* Giảm từ 50px */
                padding: 0.4rem;
            }
            .navbar a {
                font-size: 0.65rem; /* Giảm từ 0.75rem */
            }
            .navbar a i {
                font-size: 0.9rem; /* Giảm từ 1rem */
            }
            .card {
                padding: 1rem;
            }
            .card h3 {
                font-size: 1rem; /* Giảm từ 1.25rem */
            }
            .notes-form textarea, .doc-content textarea {
                height: 80px; /* Giảm từ 100px */
                font-size: 0.7rem; /* Giảm từ 0.8rem */
            }
            .member-table {
                display: none;
            }
            .member-cards {
                display: block;
            }
            .member-card p {
                font-size: 0.65rem; /* Giảm từ 0.75rem */
            }
            .button-group {
                flex-wrap: wrap;
            }
            .chart-container {
                max-width: 100%;
            }
            .rank-list li {
                font-size: 0.65rem; /* Giảm từ 0.75rem */
            }
            .stat-card h4 {
                font-size: 0.8rem; /* Giảm từ 0.9rem */
            }
            .stat-card p {
                font-size: 1rem; /* Giảm từ 1.2rem */
            }
        }

        @media (min-width: 1025px) {
            .member-cards {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="popup-overlay" id="successOverlay">
        <div class="popup" id="successPopup">
            <p id="successMessage"></p>
            <button class="btn mt-3" onclick="closeSuccessPopup()">Thoát</button>
        </div>
    </div>

    <div class="header">
        <h2>ADMIN DASHBOARD</h2>
    </div>

    <div class="navbar" id="navbar">
        <a href="#home" class="active" data-tooltip="Trang Chủ"><i class="fas fa-home"></i><span></span></a>
        <a href="#management" data-tooltip="Quản Lý Thành Viên"><i class="fas fa-users"></i><span></span></a>
        <a href="#notes" data-tooltip="Ghi Chú"><i class="fas fa-sticky-note"></i><span></span></a>
    </div>

    <div class="container">
        <div id="home" class="card active">
            <h3>Thống Kê Tổng Quan</h3>
            <div id="dataError" class="error-message" style="display: none;"></div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Tổng Số Thành Viên</h4>
                    <p id="totalMembers">0</p>
                </div>
                <div class="stat-card">
                    <h4>Thành Viên Theo Ban</h4>
                    <p id="groupStats">-</p>
                </div>
            </div>
            <h3>Phân Bố Điểm Số Top 10</h3>
            <div class="chart-container">
                <canvas id="pointsChart"></canvas>
            </div>
            <h3>Top 10 Thành Viên Điểm Cao Nhất</h3>
            <ul class="rank-list" id="topMembers"></ul>
            <h3>Top 3 Từng Ban</h3>
            <ul class="rank-list" id="top3ByGroup"></ul>
            <h3>Thành Viên Mới Nhất</h3>
            <ul class="rank-list" id="newestMembers"></ul>
            <h3>Thống Kê Hạng Thành Viên</h3>
            <div class="stats-grid" id="rankStats"></div>
        </div>

        <div id="management" class="card">
            <h3>Quản Lý Thành Viên</h3>
            <div class="mb-3">
                <label class="block mb-1 text-text">Chọn Ban:</label>
                <select id="groupFilter" class="input" onchange="filterMembers()">
                    <option value="all">Tất cả</option>
                    <option value="enviroment">Ban Vệ Sinh - Y Tế</option>
                    <option value="media">Ban Truyền Thông</option>
                    <option value="active">Ban Sinh Hoạt</option>
                    <option value="bantruc">Ban Trực</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="block mb-1 text-text">Tìm kiếm theo tên:</label>
                <input type="text" id="searchInput" class="input" placeholder="Nhập tên thành viên..." oninput="filterMembers()">
            </div>
            <table class="member-table">
                <thead>
                    <tr>
                        <th>Họ và Tên Thánh</th>
                        <th>Ban</th>
                        <th>Vai trò</th>
                        <th>Điểm</th>
                        <th>Hạng</th>
                    </tr>
                </thead>
                <tbody id="memberTableBody"></tbody>
            </table>
            <div class="member-cards" id="memberCards"></div>
            <div class="doc-content">
                <h4>Nội Dung Google Doc</h4>
                <textarea id="docContentBody" readonly placeholder="Nội dung Google Doc sẽ hiển thị tại đây..."></textarea>
                <p class="mt-2 text-[var(--text)]">Sao chép nội dung từ <a href="https://docs.google.com/document/d/1b4jqf3KQufSAoFncnYnFJVQTfurkWU5POWaNVYRpgbY/edit?usp=sharing" target="_blank" class="text-[var(--accent)]">Google Doc</a> và dán vào đây.</p>
            </div>
        </div>

        <div id="notes" class="card">
            <h3>Ghi Chú</h3>
            <form id="noteForm" action="https://formsubmit.co/notification2411.huynhdutruong@gmail.com" method="POST" class="notes-form">
                <div class="mb-3 input-group">
                    <label class="block mb-1 text-text">Ngày Tháng Năm:</label>
                    <input type="text" name="date" id="noteDate" class="input" readonly required>
                    <i class="fas fa-sync-alt" onclick="updateDateTime()"></i>
                </div>
                <div class="mb-3 input-group">
                    <label class="block mb-1 text-text">Giờ Phút Giây:</label>
                    <input type="text" name="time" id="noteTime" class="input" readonly required>
                    <i class="fas fa-sync-alt" onclick="updateDateTime()"></i>
                </div>
                <div class="mb-3">
                    <label class="block mb-1 text-text">Tiêu Đề (tối đa 30 ký tự):</label>
                    <input type="text" name="title" id="noteTitle" class="input" maxlength="30" required>
                </div>
                <div class="mb-3">
                    <label class="block mb-1 text-text">Nội Dung (tối đa 300 ký tự):</label>
                    <textarea id="noteContent" name="content" class="input" maxlength="300" placeholder="Viết nội dung ghi chú tại đây..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="block mb-1 text-text">Trưởng Nộp:</label>
                    <input type="text" name="submitter" id="noteSubmitter" class="input" readonly required>
                </div>
                <div class="mb-3">
                    <label class="flex items-center">
                        <input type="text" name="verify" id="noteVerify" required>
                        <span class="ml-2">Xác minh thông tin trên chính xác</span>
                    </label>
                </div>
                <div class="button-group">
                    <button type="submit" id="saveNoteBtn" class="btn">Gửi</button>
                    <button type="button" id="loadDraftBtn" class="btn" onclick="loadNoteDraft()">Tải Nháp</button>
                </div>
            </form>
            <p class="mt-2 text-[var(--text)]">Ghi chú sẽ được gửi qua email và có thể quản lý tại <a href="https://docs.google.com/document/d/1b4jqf3KQufSAoFncnYnFJVQTfurkWU5POWaNVYRpgbY/edit?usp=sharing" target="_blank" class="text-[var(--accent)]">Google Doc</a>.</p>
        </div>
    </div>

    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        const isMobile = window.innerWidth <= 1024;
        const loggedInUser = sessionStorage.getItem('loggedInUser') || 'Admin';
        let pointsChart;

        // Fallback data if JSON loading fails
        const fallbackMembers = [
            { fullName: "Nguyễn Văn A", class: "Ban Truyền Thông", role: "Thành viên", memberpoint: 100, addedDate: "2025-07-01" },
            { fullName: "Trần Thị B", class: "Ban Vệ Sinh - Y Tế", role: "Thành viên", memberpoint: 200, addedDate: "2025-07-02" }
        ];

        // Load JSON data
        let allMembers = [];
        async function loadJsonData() {
            const files = ['enviroment.json', 'media.json', 'active.json', 'bantruc.json'];
            const dataError = document.getElementById('dataError');
            let errorMessages = [];

            try {
                for (const file of files) {
                    console.log(`Đang tải tệp: data/${file}`);
                    const response = await fetch(`data/${file}`);
                    if (!response.ok) {
                        throw new Error(`Không thể tải ${file}: ${response.statusText}`);
                    }
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        throw new Error(`Lỗi phân tích JSON trong ${file}: ${parseError.message}`);
                    }
                    if (!data.members || !Array.isArray(data.members)) {
                        throw new Error(`Dữ liệu trong ${file} không hợp lệ: Thiếu mảng members`);
                    }
                    const group = file.split('.')[0];
                    allMembers = allMembers.concat(data.members.map(member => ({
                        ...member,
                        group: group === 'enviroment' ? 'Ban Vệ Sinh - Y Tế' : 
                               group === 'media' ? 'Ban Truyền Thông' : 
                               group === 'active' ? 'Ban Sinh Hoạt' : 'Ban Trực'
                    })));
                    console.log(`Tải thành công ${file}: ${data.members.length} thành viên`);
                }

                if (allMembers.length === 0) {
                    throw new Error('Không có dữ liệu thành viên nào được tải');
                }

                populateStats();
                populateTopMembers();
                populateTop3ByGroup();
                populateNewestMembers();
                populateRankStats();
                renderPointsChart();
                filterMembers();
                populateNoteForm();
                updateDateTime();
                loadGoogleDocContent();
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu JSON:', error);
                errorMessages.push(error.message);
                dataError.textContent = `Lỗi tải dữ liệu: ${errorMessages.join(', ')}. Sử dụng dữ liệu mẫu.`;
                dataError.style.display = 'block';
                
                // Sử dụng dữ liệu mẫu
                allMembers = fallbackMembers;
                populateStats();
                populateTopMembers();
                populateTop3ByGroup();
                populateNewestMembers();
                populateRankStats();
                renderPointsChart();
                filterMembers();
                populateNoteForm();
                updateDateTime();
                loadGoogleDocContent();
            }
        }

        // Load Google Doc content (placeholder)
        function loadGoogleDocContent() {
            const docContent = document.getElementById('docContentBody');
            docContent.value = 'Vui lòng sao chép nội dung từ Google Doc và dán vào đây.\nLink: https://docs.google.com/document/d/1b4jqf3KQufSAoFncnYnFJVQTfurkWU5POWaNVYRpgbY/edit?usp=sharing';
        }

        // Populate stats
        function populateStats() {
            const totalMembers = allMembers.length;
            const groupCounts = allMembers.reduce((acc, member) => {
                acc[member.group] = (acc[member.group] || 0) + 1;
                return acc;
            }, {});
            const groupStats = Object.entries(groupCounts)
                .map(([group, count]) => `${group}: ${count}`)
                .join(', ');

            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('groupStats').textContent = groupStats || 'Không có dữ liệu';
        }

        // Render points chart
        function renderPointsChart() {
            const ctx = document.getElementById('pointsChart').getContext('2d');
            const topMembers = allMembers
                .sort((a, b) => (Number(b.memberpoint) || 0) - (Number(a.memberpoint) || 0))
                .slice(0, 10);
            const labels = topMembers.map(member => member.fullName);
            const data = topMembers.map(member => Number(member.memberpoint) || 0);

            if (pointsChart) pointsChart.destroy();
            pointsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm số',
                        data: data,
                        backgroundColor: 'rgba(255, 215, 0, 0.6)',
                        borderColor: '#ebebeb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Điểm', color: '#ebebeb' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ebebeb', font: { size: 10 } } /* Giảm font chữ trục */
                        },
                        x: {
                            title: { display: true, text: 'Thành viên', color: '#ebebeb' },
                            grid: { display: false },
                            ticks: { color: '#ebebeb', font: { size: 10 } } /* Giảm font chữ trục */
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#ebebeb', font: { size: 10 } } } /* Giảm font chữ legend */
                    }
                }
            });
        }

        // Populate top 10 members
        function populateTopMembers() {
            const topMembersList = document.getElementById('topMembers');
            const sortedMembers = allMembers
                .sort((a, b) => (Number(b.memberpoint) || 0) - (Number(a.memberpoint) || 0))
                .slice(0, 10);
            topMembersList.innerHTML = sortedMembers.map((member, index) => `
                <li>
                    <span><i class="fas fa-trophy" style="color: ${index === 0 ? 'gold' : index === 1 ? 'silver' : '#cd7f32'};"></i> ${member.fullName} (${member.group})</span>
                    <span>${Number(member.memberpoint) || 0} điểm</span>
                </li>
            `).join('');
        }

        // Populate top 3 by group
        function populateTop3ByGroup() {
            const top3ByGroupList = document.getElementById('top3ByGroup');
            const groups = ['Ban Vệ Sinh - Y Tế', 'Ban Truyền Thông', 'Ban Sinh Hoạt', 'Ban Trực'];
            let html = '';
            
            groups.forEach(group => {
                const topMembers = allMembers
                    .filter(member => member.group === group)
                    .sort((a, b) => (Number(b.memberpoint) || 0) - (Number(a.memberpoint) || 0))
                    .slice(0, 3);
                if (topMembers.length > 0) {
                    html += `<li><strong>${group}</strong></li>`;
                    html += topMembers.map((member, index) => `
                        <li style="padding-left: 1rem;">
                            <span><i class="fas fa-medal" style="color: ${index === 0 ? 'gold' : index === 1 ? 'silver' : '#cd7f32'};"></i> ${member.fullName}</span>
                            <span>${Number(member.memberpoint) || 0} điểm</span>
                        </li>
                    `).join('');
                }
            });

            top3ByGroupList.innerHTML = html || '<li>Không có dữ liệu top 3.</li>';
        }

        // Populate newest members
        function populateNewestMembers() {
            const newestMembersList = document.getElementById('newestMembers');
            const sortedMembers = allMembers
                .sort((a, b) => new Date(b.addedDate || '1970-01-01') - new Date(a.addedDate || '1970-01-01'))
                .slice(0, 5);
            newestMembersList.innerHTML = sortedMembers.map(member => `
                <li>
                    <span>${member.fullName} (${member.group})</span>
                    <span>Tham gia: ${member.addedDate || 'N/A'}</span>
                </li>
            `).join('');
        }

        // Populate rank stats
        function populateRankStats() {
            const rankStats = document.getElementById('rankStats');
            const ranks = {
                'Thành Viên': 0,
                'VIP': 0,
                'Bạc': 0,
                'Vàng': 0,
                'Kim Cương': 0,
                'VVip': 0
            };
            allMembers.forEach(member => {
                const rankMatch = getMembershipRank(Number(member.memberpoint) || 0).match(/>([^<]+)</);
                const rank = rankMatch ? rankMatch[1] : 'Thành Viên';
                ranks[rank]++;
            });
            rankStats.innerHTML = Object.entries(ranks)
                .map(([rank, count]) => `
                    <div class="stat-card">
                        <h4>${rank}</h4>
                        <p>${count}</p>
                    </div>
                `)
                .join('');
        }

        // Get membership rank
        function getMembershipRank(memberScore) {
            if (!Number.isFinite(memberScore)) return '<i class="fas fa-user rank-icon"></i> Thành Viên';
            if (memberScore < 50) return '<i class="fas fa-user rank-icon"></i> Thành Viên';
            if (memberScore < 100) return '<i class="fas fa-star rank-icon"></i> VIP';
            if (memberScore < 201) return '<i class="fas fa-medal rank-icon" style="color: silver;"></i> Bạc';
            if (memberScore < 301) return '<i class="fas fa-medal rank-icon" style="color: gold;"></i> Vàng';
            if (memberScore < 501) return '<i class="fas fa-gem rank-icon" style="color: #b9f2ff;"></i> Kim Cương';
            return '<i class="fas fa-crown rank-icon" style="color: #FFD700;"></i> VVip';
        }

        // Filter and populate member table and cards
        function filterMembers() {
            const groupFilter = document.getElementById('groupFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const memberTableBody = document.getElementById('memberTableBody');
            const memberCards = document.getElementById('memberCards');
            let filteredMembers = allMembers;

            if (groupFilter !== 'all') {
                filteredMembers = filteredMembers.filter(member => 
                    member.group === (groupFilter === 'enviroment' ? 'Ban Vệ Sinh - Y Tế' : 
                                     groupFilter === 'media' ? 'Ban Truyền Thông' : 
                                     groupFilter === 'active' ? 'Ban Sinh Hoạt' : 'Ban Trực')
                );
            }

            if (searchInput) {
                filteredMembers = filteredMembers.filter(member => 
                    member.fullName.toLowerCase().includes(searchInput)
                );
            }

            // Populate table
            memberTableBody.innerHTML = filteredMembers.length > 0 ? filteredMembers.map(member => `
                <tr>
                    <td>${member.fullName}</td>
                    <td>${member.group}</td>
                    <td>${member.role || 'Thành viên'}</td>
                    <td>${Number(member.memberpoint) || 0}</td>
                    <td>${getMembershipRank(Number(member.memberpoint) || 0)}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center">Không tìm thấy thành viên.</td></tr>';

            // Populate cards for mobile
            memberCards.innerHTML = filteredMembers.length > 0 ? filteredMembers.map(member => `
                <div class="member-card">
                    <p><strong>Họ và Tên:</strong> ${member.fullName}</p>
                    <p><strong>Ban:</strong> ${member.group}</p>
                    <p><strong>Vai trò:</strong> ${member.role || 'Thành viên'}</p>
                    <p><strong>Điểm:</strong> ${Number(member.memberpoint) || 0}</p>
                    <p><strong>Hạng:</strong> ${getMembershipRank(Number(member.memberpoint) || 0)}</p>
                </div>
            `).join('') : '<p class="text-center">Không tìm thấy thành viên.</p>';
        }

        // Populate note form
        function populateNoteForm() {
            const noteSubmitter = document.getElementById('noteSubmitter');
            noteSubmitter.value = `Admin (${loggedInUser})`;
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('vi-VN', { hour12: false });
            document.getElementById('noteDate').value = date;
            document.getElementById('noteTime').value = time;
        }

        // Save note draft to localStorage
        function saveNoteDraft() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            if (title || content) {
                localStorage.setItem('noteDraft', JSON.stringify({ title, content }));
            }
        }

        // Load note draft from localStorage
        function loadNoteDraft() {
            const draft = localStorage.getItem('noteDraft');
            if (draft) {
                const { title, content } = JSON.parse(draft);
                document.getElementById('noteTitle').value = title || '';
                document.getElementById('noteContent').value = content || '';
                document.getElementById('successMessage').textContent = 'Đã tải nháp ghi chú.';
                document.getElementById('successMessage').style.color = 'var(--success-color)';
                showSuccessPopup();
            } else {
                document.getElementById('successMessage').textContent = 'Không có nháp nào được lưu.';
                document.getElementById('successMessage').style.color = 'var(--error)';
                showSuccessPopup();
            }
        }

        // Anti-spam mechanism
        let isSubmitting = false;
        function disableSubmitButtons() {
            isSubmitting = true;
            const saveNoteBtn = document.getElementById('saveNoteBtn');
            saveNoteBtn.disabled = true;
            setTimeout(() => {
                isSubmitting = false;
                saveNoteBtn.disabled = false;
            }, 5000);
        }

        // Note form submission
        document.getElementById('noteForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const verify = document.getElementById('noteVerify').value.trim();
            const successMessage = document.getElementById('successMessage');

            if (!title) {
                successMessage.textContent = 'Vui lòng nhập tiêu đề.';
                successMessage.style.color = 'var(--error)';
                showSuccessPopup();
                return;
            }

            if (!content) {
                successMessage.textContent = 'Vui lòng nhập nội dung ghi chú.';
                successMessage.style.color = 'var(--error)';
                showSuccessPopup();
                return;
            }

            if (!verify) {
                successMessage.textContent = 'Vui lòng xác minh thông tin.';
                successMessage.style.color = 'var(--error)';
                showSuccessPopup();
                return;
            }

            successMessage.textContent = 'Ghi chú đã được gửi qua email.';
            successMessage.style.color = 'var(--success-color)';
            disableSubmitButtons();
            showSuccessPopup();
            document.getElementById('noteForm').submit();
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteVerify').value = '';
            localStorage.removeItem('noteDraft');
            updateDateTime();
        });

        // Save note draft on input
        document.getElementById('noteTitle')?.addEventListener('input', saveNoteDraft);
        document.getElementById('noteContent')?.addEventListener('input', saveNoteDraft);

        function showSuccessPopup() {
            document.getElementById('successOverlay').style.display = 'block';
            document.getElementById('successPopup').style.display = 'block';
            setTimeout(() => {
                closeSuccessPopup();
                showSection('home');
            }, 2000);
        }

        function closeSuccessPopup() {
            document.getElementById('successOverlay').style.display = 'none';
            document.getElementById('successPopup').style.display = 'none';
            document.getElementById('noteForm').reset();
            populateNoteForm();
            updateDateTime();
        }

        // Section navigation
        const sections = ['home', 'management', 'notes'];
        function showSection(sectionId) {
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) targetSection.classList.add('active');
            document.querySelectorAll('.navbar a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').substring(1) === sectionId) {
                    link.classList.add('active');
                }
            });
            document.title = `Admin Dashboard - ${sectionId === 'home' ? 'Trang Chủ' : sectionId === 'management' ? 'Quản Lý' : 'Ghi Chú'}`;
        }

        // Attach navigation events
        function setupNavigation() {
            document.querySelectorAll('.navbar a').forEach(link => {
                link.removeEventListener('click', handleNavClick);
                link.addEventListener('click', handleNavClick);
            });
        }

        function handleNavClick(e) {
            e.preventDefault();
            const sectionId = e.currentTarget.getAttribute('href').substring(1);
            showSection(sectionId);
        }

        // Back to top button visibility
        function toggleBackToTop() {
            const backToTop = document.getElementById('backToTop');
            if (window.scrollY > 200 && isMobile) {
                backToTop.style.display = 'block';
            } else {
                backToTop.style.display = 'none';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadJsonData();
            setupNavigation();
            showSection('home');
            window.addEventListener('scroll', toggleBackToTop);
        });
    </script>
</body>
</html>
